

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pydicom.filewriter &mdash; pydicom 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/pydicom.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/css/pydicom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="pydicom 1.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pydicom
          

          
            
            <img src="../../_static/pydicom_flat_black.svg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started with pydicom</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pydicom_user_guide.html">Pydicom User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pydicom_dev_guide.html">Pydicom Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ref_guide.html">Pydicom APIâ€™s Reference Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">General examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#image-processing">Image processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#input-output">Input-output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#metadata-processing">Metadata processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pydicom</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pydicom.filewriter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pydicom.filewriter</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2008-2017 pydicom authors. See LICENSE file for details.</span>
<span class="sd">&quot;&quot;&quot;Functions related to writing DICOM data.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="k">import</span> <span class="n">pack</span>

<span class="kn">from</span> <span class="nn">pydicom</span> <span class="k">import</span> <span class="n">compat</span>
<span class="kn">from</span> <span class="nn">pydicom.compat</span> <span class="k">import</span> <span class="n">in_py2</span>
<span class="kn">from</span> <span class="nn">pydicom.charset</span> <span class="k">import</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">text_VRs</span><span class="p">,</span> <span class="n">convert_encodings</span>
<span class="kn">from</span> <span class="nn">pydicom.datadict</span> <span class="k">import</span> <span class="n">keyword_for_tag</span>
<span class="kn">from</span> <span class="nn">pydicom.dataset</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">pydicom.filebase</span> <span class="k">import</span> <span class="n">DicomFile</span><span class="p">,</span> <span class="n">DicomFileLike</span>
<span class="kn">from</span> <span class="nn">pydicom.multival</span> <span class="k">import</span> <span class="n">MultiValue</span>
<span class="kn">from</span> <span class="nn">pydicom.tag</span> <span class="k">import</span> <span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">ItemTag</span><span class="p">,</span> <span class="n">ItemDelimiterTag</span><span class="p">,</span> <span class="n">SequenceDelimiterTag</span><span class="p">,</span>
                         <span class="n">tag_in_exception</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pydicom.uid</span> <span class="k">import</span> <span class="p">(</span><span class="n">PYDICOM_IMPLEMENTATION_UID</span><span class="p">,</span> <span class="n">ImplicitVRLittleEndian</span><span class="p">,</span>
                         <span class="n">ExplicitVRBigEndian</span><span class="p">,</span>
                         <span class="n">UncompressedPixelTransferSyntaxes</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pydicom.valuerep</span> <span class="k">import</span> <span class="n">extra_length_VRs</span>
<span class="kn">from</span> <span class="nn">pydicom.values</span> <span class="k">import</span> <span class="n">convert_numbers</span>
<span class="kn">from</span> <span class="nn">pydicom._version</span> <span class="k">import</span> <span class="n">__version__</span>


<span class="k">def</span> <span class="nf">correct_ambiguous_vr_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to correct the ambiguous VR element `elem`.</span>

<span class="sd">    When it&#39;s not possible to correct the VR, the element will be returned</span>
<span class="sd">    unchanged. Currently the only ambiguous VR elements not corrected for are</span>
<span class="sd">    all retired or part of DICONDE.</span>

<span class="sd">    If the VR is corrected and is &#39;US&#39; or &#39;SS&#39; then the value will be updated</span>
<span class="sd">    using the pydicom.values.convert_numbers() method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elem : pydicom.dataelem.DataElement</span>
<span class="sd">        The element with an ambiguous VR.</span>
<span class="sd">    ds : pydicom.dataset.Dataset</span>
<span class="sd">        The dataset containing `elem`.</span>
<span class="sd">    is_little_endian : bool</span>
<span class="sd">        The byte ordering of the values in the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elem : pydicom.dataelem.DataElement</span>
<span class="sd">        The corrected element</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;or&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">VR</span><span class="p">:</span>
        <span class="c1"># &#39;OB or OW&#39;: 7fe0,0010 PixelData</span>
        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="mh">0x7fe00010</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Compressed Pixel Data</span>
                <span class="c1"># PS3.5 Annex A.4</span>
                <span class="c1">#   If encapsulated, VR is OB and length is undefined</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">is_undefined_length</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OB&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Non-compressed Pixel Data</span>
                    <span class="c1"># If BitsAllocated is &gt; 8 then OW, else may be OB or OW</span>
                    <span class="c1">#   as per PS3.5 Annex A.2. For BitsAllocated &lt; 8 test the</span>
                    <span class="c1">#    size of each pixel to see if its written in OW or OB</span>
                    <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">BitsAllocated</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OW&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">PixelData</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">Rows</span> <span class="o">*</span> <span class="n">ds</span><span class="o">.</span><span class="n">Columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OW&#39;</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">PixelData</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">Rows</span> <span class="o">*</span> <span class="n">ds</span><span class="o">.</span><span class="n">Columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OB&#39;</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># &#39;US or SS&#39; and dependent on PixelRepresentation</span>
        <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="mh">0x00189810</span><span class="p">,</span> <span class="mh">0x00221452</span><span class="p">,</span> <span class="mh">0x00280104</span><span class="p">,</span> <span class="mh">0x00280105</span><span class="p">,</span> <span class="mh">0x00280106</span><span class="p">,</span>
                <span class="mh">0x00280107</span><span class="p">,</span> <span class="mh">0x00280108</span><span class="p">,</span> <span class="mh">0x00280109</span><span class="p">,</span> <span class="mh">0x00280110</span><span class="p">,</span> <span class="mh">0x00280111</span><span class="p">,</span>
                <span class="mh">0x00280120</span><span class="p">,</span> <span class="mh">0x00280121</span><span class="p">,</span> <span class="mh">0x00281101</span><span class="p">,</span> <span class="mh">0x00281102</span><span class="p">,</span> <span class="mh">0x00281103</span><span class="p">,</span>
                <span class="mh">0x00283002</span><span class="p">,</span> <span class="mh">0x00409211</span><span class="p">,</span> <span class="mh">0x00409216</span><span class="p">,</span> <span class="mh">0x00603004</span><span class="p">,</span> <span class="mh">0x00603006</span>
        <span class="p">]:</span>
            <span class="c1"># US if PixelRepresenation value is 0x0000, else SS</span>
            <span class="c1">#   For references, see the list at</span>
            <span class="c1">#   https://github.com/darcymason/pydicom/pull/298</span>
            <span class="k">if</span> <span class="s1">&#39;PixelRepresentation&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">PixelRepresentation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;US&#39;</span>
                    <span class="n">byte_type</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;SS&#39;</span>
                    <span class="n">byte_type</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">convert_numbers</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">,</span>
                                             <span class="n">byte_type</span><span class="p">)</span>

        <span class="c1"># &#39;OB or OW&#39; and dependent on WaveformBitsAllocated</span>
        <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="mh">0x54000100</span><span class="p">,</span> <span class="mh">0x54000112</span><span class="p">,</span> <span class="mh">0x5400100A</span><span class="p">,</span> <span class="mh">0x54001010</span><span class="p">]:</span>
            <span class="c1"># If WaveformBitsAllocated is &gt; 8 then OW, otherwise may be</span>
            <span class="c1">#   OB or OW, however not sure how to handle this.</span>
            <span class="c1">#   See PS3.3 C.10.9.1.</span>
            <span class="k">if</span> <span class="s1">&#39;WaveformBitsAllocated&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">WaveformBitsAllocated</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OW&#39;</span>

        <span class="c1"># &#39;US or OW&#39;: 0028,3006 LUTData</span>
        <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="mh">0x00283006</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;LUTDescriptor&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
                <span class="c1"># First value in LUT Descriptor is how many values in</span>
                <span class="c1">#   LUTData, if there&#39;s only one value then must be US</span>
                <span class="c1"># As per PS3.3 C.11.1.1.1</span>
                <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">LUTDescriptor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;US&#39;</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">convert_numbers</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">,</span>
                                                 <span class="s1">&#39;H&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OW&#39;</span>

        <span class="c1"># &#39;OB or OW&#39;: 60xx,3000 OverlayData and dependent on Transfer Syntax</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x6000</span><span class="p">,</span> <span class="mh">0x601F</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">elem</span> <span class="o">==</span> <span class="mh">0x3000</span><span class="p">):</span>
            <span class="c1"># Implicit VR must be OW, explicit VR may be OB or OW</span>
            <span class="c1">#   as per PS3.5 Section 8.1.2 and Annex A</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;is_implicit_VR&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ds</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="s1">&#39;OW&#39;</span>

    <span class="k">return</span> <span class="n">elem</span>


<span class="k">def</span> <span class="nf">correct_ambiguous_vr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate through `ds` correcting ambiguous VR elements (if possible).</span>

<span class="sd">    When it&#39;s not possible to correct the VR, the element will be returned</span>
<span class="sd">    unchanged. Currently the only ambiguous VR elements not corrected for are</span>
<span class="sd">    all retired or part of DICONDE.</span>

<span class="sd">    If the VR is corrected and is &#39;US&#39; or &#39;SS&#39; then the value will be updated</span>
<span class="sd">    using the pydicom.values.convert_numbers() method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : pydicom.dataset.Dataset</span>
<span class="sd">        The dataset containing ambiguous VR elements.</span>
<span class="sd">    is_little_endian : bool</span>
<span class="sd">        The byte ordering of the values in the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ds : pydicom.dataset.Dataset</span>
<span class="sd">        The corrected dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Iterate through the elements</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="c1"># Iterate the correction through any sequences</span>
        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">VR</span> <span class="o">==</span> <span class="s1">&#39;SQ&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">correct_ambiguous_vr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;or&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">VR</span><span class="p">:</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">correct_ambiguous_vr_element</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">is_little_endian</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span> <span class="nf">write_numbers</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">struct_format</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a &quot;value&quot; of type struct_format from the dicom file.</span>

<span class="sd">    &quot;Value&quot; can be more than one number.</span>

<span class="sd">    struct_format -- the character format as used by the struct module.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endianChar</span> <span class="o">=</span> <span class="s1">&#39;&gt;&lt;&#39;</span> <span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># don&#39;t need to write anything for empty string</span>

    <span class="n">format_string</span> <span class="o">=</span> <span class="n">endianChar</span> <span class="o">+</span> <span class="n">struct_format</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">append</span>  <span class="c1"># works only if list, not if string or number</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># is a single value - the usual case</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">format_string</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">format_string</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">for data_element:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_element</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">write_OBvalue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a data_element with VR of &#39;other byte&#39; (OB).&quot;&quot;&quot;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_OWvalue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a data_element with VR of &#39;other word&#39; (OW).</span>

<span class="sd">    Note: This **does not currently do the byte swapping** for Endian state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># XXX for now just write the raw bytes without endian swapping</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_UI</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a data_element with VR of &#39;unique identifier&#39; (UI).&quot;&quot;&quot;</span>
    <span class="n">write_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># pad with 0-byte to even length</span>


<span class="k">def</span> <span class="nf">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if `val` is a multi-value container.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">MultiValue</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">multi_string</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Put a string together with delimiter if has more than one value&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="c1"># \ is escape chr, so &quot;\\&quot; gives single backslash</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">write_PN</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">encoding</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_encoding</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">data_element</span><span class="o">.</span><span class="n">VM</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">compat</span><span class="o">.</span><span class="n">text_type</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">in_py2</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>

    <span class="n">val</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>

    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">default_encoding</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a single or multivalued string.&quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">multi_string</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>  <span class="c1"># pad to even length</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">text_type</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_number_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle IS or DS VR - write a number stored as a string of digits.&quot;&quot;&quot;</span>
    <span class="c1"># If the DS or IS has an original_string attribute, use that, so that</span>
    <span class="c1"># unchanged data elements are written with exact string as when read from</span>
    <span class="c1"># file</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="n">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">original_string</span>
                         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;original_string&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;original_string&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">original_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>  <span class="c1"># pad to even length</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_py2</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>

    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_DA</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;original_string&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">original_string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_DA</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)):</span>
        <span class="n">write_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span>
                             <span class="k">else</span> <span class="n">_format_DA</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_format_DA</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>  <span class="c1"># pad to even length</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">default_encoding</span><span class="p">)</span>

        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_DT</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;original_string&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">original_string</span>
    <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S.</span><span class="si">%f</span><span class="s2">%z&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S%z&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_DT</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)):</span>
        <span class="n">write_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span>
                             <span class="k">else</span> <span class="n">_format_DT</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_format_DT</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>  <span class="c1"># pad to even length</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">default_encoding</span><span class="p">)</span>

        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_TM</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;original_string&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">original_string</span>
    <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M%S&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_TM</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)):</span>
        <span class="n">write_string</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_multi_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span>
                             <span class="k">else</span> <span class="n">_format_TM</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_format_TM</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">padding</span>  <span class="c1"># pad to even length</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">default_encoding</span><span class="p">)</span>

        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_data_element</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">default_encoding</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write the data_element to file fp according to dicom media storage rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Write element&#39;s tag</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

    <span class="c1"># If explicit VR, write the VR</span>
    <span class="n">VR</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">VR</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">VR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot write ambiguous VR of &#39;</span><span class="si">{}</span><span class="s2">&#39; for data element with &quot;</span>
                   <span class="s2">&quot;tag </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Set the correct VR before writing, or use an &quot;</span>
                   <span class="s2">&quot;implicit VR transfer syntax&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">VR</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">tag</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_py2</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">VR</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">VR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VR</span> <span class="ow">in</span> <span class="n">extra_length_VRs</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write_US</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># reserved 2 bytes</span>
    <span class="k">if</span> <span class="n">VR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">writers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;write_data_element: unknown Value Representation &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">VR</span><span class="p">))</span>

    <span class="n">length_location</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span class="c1"># save location for later.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="ow">and</span> <span class="n">VR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_length_VRs</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_US</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Explicit VR length field is only 2 bytes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span>
            <span class="mh">0xFFFFFFFF</span>
        <span class="p">)</span>  <span class="c1"># will fill in real length value later if not undefined length item</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="n">convert_encodings</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

    <span class="n">writer_function</span><span class="p">,</span> <span class="n">writer_param</span> <span class="o">=</span> <span class="n">writers</span><span class="p">[</span><span class="n">VR</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">VR</span> <span class="ow">in</span> <span class="n">text_VRs</span><span class="p">:</span>
        <span class="n">writer_function</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">VR</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;SQ&#39;</span><span class="p">):</span>
        <span class="n">writer_function</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Many numeric types use the same writer but with numeric format</span>
        <span class="c1"># parameter</span>
        <span class="k">if</span> <span class="n">writer_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">writer_function</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">writer_param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer_function</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">)</span>

    <span class="c1">#  print DataElement(tag, VR, value)</span>

    <span class="n">is_undefined_length</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data_element</span><span class="p">,</span> <span class="s2">&quot;is_undefined_length&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">data_element</span><span class="o">.</span><span class="n">is_undefined_length</span><span class="p">):</span>
        <span class="n">is_undefined_length</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># valid pixel data with undefined length shall contain encapsulated</span>
        <span class="c1"># data, e.g. sequence items - raise ValueError otherwise (see #238)</span>
        <span class="k">if</span> <span class="n">data_element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="mh">0x7fe00010</span><span class="p">:</span>  <span class="c1"># pixel data</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="ow">and</span> <span class="ow">not</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xfe\xff\x00\xe0</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="ow">not</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xfe\xe0\x00</span><span class="s1">&#39;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Pixel Data with undefined length must &#39;</span>
                                 <span class="s1">&#39;start with an item tag&#39;</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">length_location</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="ow">and</span> <span class="n">VR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_length_VRs</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_US</span><span class="p">(</span><span class="n">location</span> <span class="o">-</span> <span class="n">length_location</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 2 is length of US</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># write the proper length of the data_element back in the length slot,</span>
        <span class="c1"># unless is SQ with undefined length.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_undefined_length</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span><span class="n">location</span> <span class="o">-</span> <span class="n">length_location</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 4 is length of UL</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>  <span class="c1"># ready for next data_element</span>
    <span class="k">if</span> <span class="n">is_undefined_length</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">SequenceDelimiterTag</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 4-byte &#39;length&#39; of delimiter data item</span>


<span class="k">def</span> <span class="nf">write_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">parent_encoding</span><span class="o">=</span><span class="n">default_encoding</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a Dataset dictionary to the file. Return the total length written.</span>

<span class="sd">    Attempt to correct ambiguous VR elements when explicit little/big</span>
<span class="sd">      encoding Elements that can&#39;t be corrected will be returned unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">correct_ambiguous_vr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

    <span class="n">dataset_encoding</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SpecificCharacterSet&#39;</span><span class="p">,</span> <span class="n">parent_encoding</span><span class="p">)</span>

    <span class="n">fpStart</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="c1"># data_elements must be written in tag order</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tag_in_exception</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="c1"># write_data_element(fp, dataset.get_item(tag), dataset_encoding)</span>
            <span class="c1"># XXX for writing raw tags without converting to DataElement</span>
            <span class="n">write_data_element</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="n">dataset_encoding</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="n">fpStart</span>


<span class="k">def</span> <span class="nf">write_sequence</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a dicom Sequence contained in data_element to the file fp.&quot;&quot;&quot;</span>
    <span class="c1"># write_data_element has already written the VR=&#39;SQ&#39; (if needed) and</span>
    <span class="c1">#    a placeholder for length&quot;&quot;&quot;</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="n">write_sequence_item</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_sequence_item</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write an item (dataset) in a dicom Sequence to the dicom file fp.</span>

<span class="sd">    This is similar to writing a data_element, but with a specific tag for</span>
<span class="sd">    Sequence Item</span>

<span class="sd">    see Dicom standard Part 5, p. 39 (&#39;03 version)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">ItemTag</span><span class="p">)</span>  <span class="c1"># marker for start of Sequence Item</span>
    <span class="n">length_location</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span class="c1"># save location for later.</span>
    <span class="c1"># will fill in real value later if not undefined length</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">)</span>
    <span class="n">write_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">parent_encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;is_undefined_length_sequence_item&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">ItemDelimiterTag</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 4-bytes &#39;length&#39; field for delimiter item</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># we will be nice and set the lengths for the reader of this file</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">length_location</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_UL</span><span class="p">(</span><span class="n">location</span> <span class="o">-</span> <span class="n">length_location</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 4 is length of UL</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>  <span class="c1"># ready for next data_element</span>


<span class="k">def</span> <span class="nf">write_UN</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a byte string for an DataElement of value &#39;UN&#39; (unknown).&quot;&quot;&quot;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_ATvalue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a data_element tag to a file.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">iter</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># see if is multi-valued AT;</span>
        <span class="c1"># Note will fail if Tag ever derived from true tuple rather than being</span>
        <span class="c1"># a long</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># make sure is expressed as a Tag instance</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">Tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">data_element</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_file_meta_info</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">file_meta</span><span class="p">,</span> <span class="n">enforce_standard</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write the File Meta Information elements in `file_meta` to `fp`.</span>

<span class="sd">    If `enforce_standard` is True then the file-like `fp` should be positioned</span>
<span class="sd">    past the 128 byte preamble + 4 byte prefix (which should already have been</span>
<span class="sd">    written).</span>

<span class="sd">    DICOM File Meta Information Group Elements</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    From the DICOM standard, Part 10 Section 7.1, any DICOM file shall contain</span>
<span class="sd">    a 128-byte preamble, a 4-byte DICOM prefix &#39;DICM&#39; and (at a minimum) the</span>
<span class="sd">    following Type 1 DICOM Elements (from Table 7.1-1):</span>
<span class="sd">        * (0002,0000) FileMetaInformationGroupLength, UL, 4</span>
<span class="sd">        * (0002,0001) FileMetaInformationVersion, OB, 2</span>
<span class="sd">        * (0002,0002) MediaStorageSOPClassUID, UI, N</span>
<span class="sd">        * (0002,0003) MediaStorageSOPInstanceUID, UI, N</span>
<span class="sd">        * (0002,0010) TransferSyntaxUID, UI, N</span>
<span class="sd">        * (0002,0012) ImplementationClassUID, UI, N</span>

<span class="sd">    If `enforce_standard` is True then (0002,0000) will be added/updated,</span>
<span class="sd">    (0002,0001) and (0002,0012) will be added if not already present and the</span>
<span class="sd">    other required elements will be checked to see if they exist. If</span>
<span class="sd">    `enforce_standard` is False then `file_meta` will be written as is after</span>
<span class="sd">    minimal validation checking.</span>

<span class="sd">    The following Type 3/1C Elements may also be present:</span>
<span class="sd">        * (0002,0013) ImplementationVersionName, SH, N</span>
<span class="sd">        * (0002,0016) SourceApplicationEntityTitle, AE, N</span>
<span class="sd">        * (0002,0017) SendingApplicationEntityTitle, AE, N</span>
<span class="sd">        * (0002,0018) ReceivingApplicationEntityTitle, AE, N</span>
<span class="sd">        * (0002,0100) PrivateInformationCreatorUID, UI, N</span>
<span class="sd">        * (0002,0102) PrivateInformation, OB, N</span>

<span class="sd">    If `enforce_standard` is True then (0002,0013) will be added/updated.</span>

<span class="sd">    Encoding</span>
<span class="sd">    ~~~~~~~~</span>
<span class="sd">    The encoding of the File Meta Information shall be Explicit VR Little</span>
<span class="sd">    Endian</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fp : file-like</span>
<span class="sd">        The file-like to write the File Meta Information to.</span>
<span class="sd">    file_meta : pydicom.dataset.Dataset</span>
<span class="sd">        The File Meta Information DataElements.</span>
<span class="sd">    enforce_standard : bool</span>
<span class="sd">        If False, then only the File Meta Information elements already in</span>
<span class="sd">        `file_meta` will be written to `fp`. If True (default) then a DICOM</span>
<span class="sd">        Standards conformant File Meta will be written to `fp`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `enforce_standard` is True and any of the required File Meta</span>
<span class="sd">        Information elements are missing from `file_meta`, with the</span>
<span class="sd">        exception of (0002,0000), (0002,0001) and (0002,0012).</span>
<span class="sd">    ValueError</span>
<span class="sd">        If any non-Group 2 Elements are present in `file_meta`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check that no non-Group 2 Elements are present</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">group</span> <span class="o">!=</span> <span class="mh">0x0002</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only File Meta Information Group (0002,eeee) &quot;</span>
                             <span class="s2">&quot;elements must be present in &#39;file_meta&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># The Type 1 File Meta Elements are only required when `enforce_standard`</span>
    <span class="c1">#   is True, except for FileMetaInformationGroupLength and</span>
    <span class="c1">#   FileMetaInformationVersion, which may or may not be present</span>
    <span class="k">if</span> <span class="n">enforce_standard</span><span class="p">:</span>
        <span class="c1"># Will be updated with the actual length later</span>
        <span class="k">if</span> <span class="s1">&#39;FileMetaInformationGroupLength&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">FileMetaInformationGroupLength</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s1">&#39;FileMetaInformationVersion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">FileMetaInformationVersion</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x01</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;ImplementationClassUID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">ImplementationClassUID</span> <span class="o">=</span> <span class="n">PYDICOM_IMPLEMENTATION_UID</span>

        <span class="k">if</span> <span class="s1">&#39;ImplementationVersionName&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">ImplementationVersionName</span> <span class="o">=</span> <span class="s1">&#39;PYDICOM &#39;</span> <span class="o">+</span> <span class="n">__version__</span>

        <span class="c1"># Check that required File Meta Elements are present</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">Tag</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tag</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">element</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Missing required File Meta Information elements from &quot;</span> \
                  <span class="s2">&quot;&#39;file_meta&#39;:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">keyword_for_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Remove final newline</span>

    <span class="c1"># Only used if FileMetaInformationGroupLength is present.</span>
    <span class="c1">#   FileMetaInformationGroupLength has a VR of &#39;UL&#39; and so has a value that</span>
    <span class="c1">#   is 4 bytes fixed. The total length of when encoded as Explicit VR must</span>
    <span class="c1">#   therefore be 12 bytes.</span>
    <span class="n">end_group_length_elem</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">+</span> <span class="mi">12</span>

    <span class="c1"># The &#39;is_little_endian&#39; and &#39;is_implicit_VR&#39; attributes will need to be</span>
    <span class="c1">#   set correctly after the File Meta Info has been written.</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Write the File Meta Information Group elements to `fp`</span>
    <span class="n">write_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">file_meta</span><span class="p">)</span>

    <span class="c1"># If FileMetaInformationGroupLength is present it will be the first written</span>
    <span class="c1">#   element and we must update its value to the correct length.</span>
    <span class="k">if</span> <span class="s1">&#39;FileMetaInformationGroupLength&#39;</span> <span class="ow">in</span> <span class="n">file_meta</span><span class="p">:</span>
        <span class="c1"># Save end of file meta to go back to</span>
        <span class="n">end_of_file_meta</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

        <span class="c1"># Update the FileMetaInformationGroupLength value, which is the number</span>
        <span class="c1">#   of bytes from the end of the FileMetaInformationGroupLength element</span>
        <span class="c1">#   to the end of all the File Meta Information elements</span>
        <span class="n">group_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_of_file_meta</span> <span class="o">-</span> <span class="n">end_group_length_elem</span><span class="p">)</span>
        <span class="n">file_meta</span><span class="o">.</span><span class="n">FileMetaInformationGroupLength</span> <span class="o">=</span> <span class="n">group_length</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">end_group_length_elem</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">write_data_element</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">file_meta</span><span class="p">[</span><span class="mh">0x00020000</span><span class="p">])</span>

        <span class="c1"># Return to end of the file meta, ready to write remainder of the file</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">end_of_file_meta</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dcmwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write `dataset` to the `filename` specified.</span>

<span class="sd">    If `write_like_original` is True then `dataset` will be written as is</span>
<span class="sd">    (after minimal validation checking) and may or may not contain all or parts</span>
<span class="sd">    of the File Meta Information (and hence may or may not be conformant with</span>
<span class="sd">    the DICOM File Format).</span>
<span class="sd">    If `write_like_original` is False, `dataset` will be stored in the DICOM</span>
<span class="sd">    File Format in accordance with DICOM Standard Part 10 Section 7. The byte</span>
<span class="sd">    stream of the `dataset` will be placed into the file after the DICOM File</span>
<span class="sd">    Meta Information.</span>

<span class="sd">    File Meta Information</span>
<span class="sd">    ---------------------</span>
<span class="sd">    The File Meta Information consists of a 128-byte preamble, followed by a 4</span>
<span class="sd">    byte DICOM prefix, followed by the File Meta Information Group elements.</span>

<span class="sd">    Preamble and Prefix</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    The `dataset.preamble` attribute shall be 128-bytes long or None and is</span>
<span class="sd">    available for use as defined by the Application Profile or specific</span>
<span class="sd">    implementations. If the preamble is not used by an Application Profile or</span>
<span class="sd">    specific implementation then all 128 bytes should be set to 0x00. The</span>
<span class="sd">    actual preamble written depends on `write_like_original` and</span>
<span class="sd">    `dataset.preamble` (see the table below).</span>

<span class="sd">    +------------------+------------------------------+</span>
<span class="sd">    |                  | write_like_original          |</span>
<span class="sd">    +------------------+-------------+----------------+</span>
<span class="sd">    | dataset.preamble | True        | False          |</span>
<span class="sd">    +==================+=============+================+</span>
<span class="sd">    | None             | no preamble | 128 0x00 bytes |</span>
<span class="sd">    +------------------+------------------------------+</span>
<span class="sd">    | 128 bytes        | dataset.preamble             |</span>
<span class="sd">    +------------------+------------------------------+</span>

<span class="sd">    The prefix shall be the string &#39;DICM&#39; and will be written if and only if</span>
<span class="sd">    the preamble is present.</span>

<span class="sd">    File Meta Information Group Elements</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    The preamble and prefix are followed by a set of DICOM Elements from the</span>
<span class="sd">    (0002,eeee) group. Some of these elements are required (Type 1) while</span>
<span class="sd">    others are optional (Type 3/1C). If `write_like_original` is True then the</span>
<span class="sd">    File Meta Information Group elements are all optional. See</span>
<span class="sd">    pydicom.filewriter.write_file_meta_info for more information on which</span>
<span class="sd">    elements are required.</span>

<span class="sd">    The File Meta Information Group elements should be included within their</span>
<span class="sd">    own Dataset in the `dataset.file_meta` attribute.</span>

<span class="sd">    If (0002,0010) &#39;Transfer Syntax UID&#39; is included then the user must ensure</span>
<span class="sd">    it&#39;s value is compatible with the values for the `dataset.is_little_endian`</span>
<span class="sd">    and `dataset.is_implicit_VR` attributes. For example, if is_little_endian</span>
<span class="sd">    and is_implicit_VR are both True then the Transfer Syntax UID must be</span>
<span class="sd">    1.2.840.10008.1.2 &#39;Implicit VR Little Endian&#39;. See the DICOM standard</span>
<span class="sd">    Part 5 Section 10 for more information on Transfer Syntaxes.</span>

<span class="sd">    Encoding</span>
<span class="sd">    ~~~~~~~~</span>
<span class="sd">    The preamble and prefix are encoding independent. The File Meta Elements</span>
<span class="sd">    are encoded as Explicit VR Little Endian as required by the DICOM standard.</span>

<span class="sd">    Dataset</span>
<span class="sd">    -------</span>
<span class="sd">    A DICOM Dataset representing a SOP Instance related to a DICOM Information</span>
<span class="sd">    Object Definition. It is up to the user to ensure the `dataset` conforms</span>
<span class="sd">    to the DICOM standard.</span>

<span class="sd">    Encoding</span>
<span class="sd">    ~~~~~~~~</span>
<span class="sd">    The `dataset` is encoded as specified by the `dataset.is_little_endian`</span>
<span class="sd">    and `dataset.is_implicit_VR` attributes. It&#39;s up to the user to ensure</span>
<span class="sd">    these attributes are set correctly (as well as setting an appropriate value</span>
<span class="sd">    for `dataset.file_meta.TransferSyntaxUID` if present).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str or file-like</span>
<span class="sd">        Name of file or the file-like to write the new DICOM file to.</span>
<span class="sd">    dataset : pydicom.dataset.FileDataset</span>
<span class="sd">        Dataset holding the DICOM information; e.g. an object read with</span>
<span class="sd">        pydicom.dcmread().</span>
<span class="sd">    write_like_original : bool</span>
<span class="sd">        If True (default), preserves the following information from</span>
<span class="sd">        the Dataset (and may result in a non-conformant file):</span>
<span class="sd">        - preamble -- if the original file has no preamble then none will be</span>
<span class="sd">            written.</span>
<span class="sd">        - file_meta -- if the original file was missing any required File Meta</span>
<span class="sd">            Information Group elements then they will not be added or written.</span>
<span class="sd">            If (0002,0000) &#39;File Meta Information Group Length&#39; is present then</span>
<span class="sd">            it may have its value updated.</span>
<span class="sd">        - seq.is_undefined_length -- if original had delimiters, write them now</span>
<span class="sd">            too, instead of the more sensible length characters</span>
<span class="sd">        - is_undefined_length_sequence_item -- for datasets that belong to a</span>
<span class="sd">            sequence, write the undefined length delimiters if that is</span>
<span class="sd">            what the original had.</span>
<span class="sd">        If False, produces a file conformant with the DICOM File Format, with</span>
<span class="sd">        explicit lengths for all elements.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    pydicom.dataset.FileDataset</span>
<span class="sd">        Dataset class with relevant attributes and information.</span>
<span class="sd">    pydicom.dataset.Dataset.save_as</span>
<span class="sd">        Write a DICOM file from a dataset that was read in with dcmread().</span>
<span class="sd">        save_as wraps dcmwrite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check that dataset&#39;s group 0x0002 elements are only present in the</span>
    <span class="c1">#   `dataset.file_meta` Dataset - user may have added them to the wrong</span>
    <span class="c1">#   place</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">group_dataset</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Dataset</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File Meta Information Group Elements (0002,eeee) &quot;</span>
                         <span class="s2">&quot;should be in their own Dataset object in the &quot;</span>
                         <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">.file_meta&#39; &quot;</span>
                         <span class="s2">&quot;attribute.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="c1"># A preamble is required under the DICOM standard, however if</span>
    <span class="c1">#   `write_like_original` is True we treat it as optional</span>
    <span class="n">preamble</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;preamble&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">preamble</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">.preamble&#39; must be 128-bytes &quot;</span>
                         <span class="s2">&quot;long.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">preamble</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write_like_original</span><span class="p">:</span>
        <span class="c1"># The default preamble is 128 0x00 bytes.</span>
        <span class="n">preamble</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">128</span>

    <span class="c1"># File Meta Information is required under the DICOM standard, however if</span>
    <span class="c1">#   `write_like_original` is True we treat it as optional</span>
    <span class="n">file_meta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;file_meta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_meta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">write_like_original</span><span class="p">:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">file_meta</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="n">file_meta</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">file_meta</span>

    <span class="c1"># If enforcing the standard, correct the TransferSyntaxUID where possible,</span>
    <span class="c1">#   noting that the transfer syntax for is_implicit_VR = False and</span>
    <span class="c1">#   is_little_endian = True is ambiguous as it may be an encapsulated</span>
    <span class="c1">#   transfer syntax</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">write_like_original</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">TransferSyntaxUID</span> <span class="o">=</span> <span class="n">ImplicitVRLittleEndian</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">TransferSyntaxUID</span> <span class="o">=</span> <span class="n">ExplicitVRBigEndian</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implicit VR Big Endian is not a &quot;</span>
                                      <span class="s2">&quot;supported Transfer Syntax.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;SOPClassUID&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">MediaStorageSOPClassUID</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPClassUID</span>
        <span class="k">if</span> <span class="s1">&#39;SOPInstanceUID&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">file_meta</span><span class="o">.</span><span class="n">MediaStorageSOPInstanceUID</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPInstanceUID</span>

    <span class="c1"># Check for decompression, give warnings if inconsistencies</span>
    <span class="c1"># If decompressed, then pixel_array is now used instead of PixelData</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_decompressed</span><span class="p">:</span>
        <span class="n">xfer</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">file_meta</span><span class="o">.</span><span class="n">TransferSyntaxUID</span>
        <span class="k">if</span> <span class="n">xfer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">UncompressedPixelTransferSyntaxes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file_meta transfer SyntaxUID is compressed type &quot;</span>
                             <span class="s2">&quot;but pixel data has been decompressed&quot;</span><span class="p">)</span>
        
        <span class="c1"># Force PixelData to the decompressed version</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">PixelData</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">pixel_array</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        
    <span class="n">caller_owns_file</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Open file if not already a file object</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">DicomFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="c1"># caller provided a file name; we own the file handle</span>
        <span class="n">caller_owns_file</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">DicomFileLike</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># WRITE FILE META INFORMATION</span>
        <span class="k">if</span> <span class="n">preamble</span><span class="p">:</span>
            <span class="c1"># Write the &#39;DICM&#39; prefix if and only if we write the preamble</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;DICM&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># May be an empty Dataset</span>
            <span class="c1"># If we want to `write_like_original`, don&#39;t enforce_standard</span>
            <span class="n">write_file_meta_info</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">file_meta</span><span class="p">,</span> <span class="n">enforce_standard</span><span class="o">=</span><span class="ow">not</span> <span class="n">write_like_original</span><span class="p">)</span>

        <span class="c1"># WRITE DATASET</span>
        <span class="c1"># The transfer syntax used to encode the dataset can&#39;t be changed</span>
        <span class="c1">#   within the dataset.</span>
        <span class="c1"># Write any Command Set elements now as elements must be in tag order</span>
        <span class="c1">#   Mixing Command Set with other elements is non-conformant so we</span>
        <span class="c1">#   require `write_like_original` to be True</span>
        <span class="n">command_set</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mh">0x00000000</span><span class="p">:</span><span class="mh">0x00010000</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">command_set</span> <span class="ow">and</span> <span class="n">write_like_original</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">write_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">command_set</span><span class="p">)</span>

        <span class="c1"># Set file VR and endianness. MUST BE AFTER writing META INFO (which</span>
        <span class="c1">#   requires Explicit VR Little Endian) and COMMAND SET (which requires</span>
        <span class="c1">#   Implicit VR Little Endian)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_implicit_VR</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">is_little_endian</span>

        <span class="c1"># Write non-Command Set elements now</span>
        <span class="n">write_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="mh">0x00010000</span><span class="p">:])</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">caller_owns_file</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">write_file</span> <span class="o">=</span> <span class="n">dcmwrite</span>  <span class="c1"># write_file before pydicom 1.0, kept for compatibility</span>

<span class="c1"># Map each VR to a function which can write it</span>
<span class="c1"># for write_numbers, the Writer maps to a tuple (function, struct_format)</span>
<span class="c1">#   (struct_format is python&#39;s struct module format)</span>
<span class="n">writers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;UL&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">),</span>
    <span class="s1">&#39;SL&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">),</span>
    <span class="s1">&#39;US&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">),</span>
    <span class="s1">&#39;SS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">),</span>
    <span class="s1">&#39;FL&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">),</span>
    <span class="s1">&#39;FD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">),</span>
    <span class="s1">&#39;OF&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_numbers</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">),</span>
    <span class="s1">&#39;OB&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OBvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OL&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;UI&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_UI</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;SH&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;DA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_DA</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;TM&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_TM</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;CS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;PN&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_PN</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;LO&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;IS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_number_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;DS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_number_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;AE&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;AS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;LT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;SQ&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_sequence</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;UC&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;UN&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_UN</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;UR&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;AT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_ATvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;ST&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OW&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;US or SS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;US or OW&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;US or SS or OW&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OWvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OW/OB&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OBvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OB/OW&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OBvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OB or OW&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OBvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;OW or OB&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_OBvalue</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;DT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_DT</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;UT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">write_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="p">}</span>  <span class="c1"># note OW/OB depends on other items, which we don&#39;t know at write time</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2008-2018, Darcy Mason and pydicom contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>